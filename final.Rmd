---
title: "final"
author: "Qing Xu"
date: "April 21, 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

#Exploratory Analysis

```{r}
library(dplyr)
library(tidyverse)
library(readxl)
library(janitor)
library(rworldmap)
library(rpart)
library(rpart.plot)
library(randomForest)
library(caret)
df<-read_excel("WHR2018Chapter2OnlineData.xls") %>%
  clean_names()
df<-df[,1:14]
df<-df[,-10:-11]
df<-df %>%
  drop_na()
```

##Correlation Analysis

```{r}
library(corrplot)
df_corr = df%>%
  select(-country,-year)
ladder_corr <- cor( df_corr, use = "complete", method = "pearson")
corrplot(ladder_corr)
```

We could see that GDP per capita, health life expectancy at birth, delivery quality and social support are highly correlated with life ladder. And perception of corruption has negative correlation with life ladder. But confidence in national government also has negative correlation with life ladder, though it is close to zero, which may indicate that people in countries with questioning about government may be happier.

##World Map of Happiness

```{r}
df_map = df%>%
  filter(year == 2016)%>%
  select(country,life_ladder) 
 
colnames(df_map)<-c("country","value")
correction16<-c("Guinea"="Equatorial Guinea", "Serbia"="Republic of Serbia",  "Tanzania"="United Republic of Tanzania","United States"="United States of America","United States"="United States Virgin Islands","Russia"="Russian Federation","Venezuela"="Venezuela, Bolivarian Republic of","Bolivia"="Bolivia (Plurinational State of)","South Korea"="Republic of Korea" )
for(i in names(correction16)){
  df_map[df_map$country==i,"country"]<-correction16[i]
}

d <- data.frame(
  country=df_map$country,
  value=df_map$value)

n <- joinCountryData2Map(d, joinCode="NAME", nameJoinColumn="country")
mapCountryData(n, nameColumnToPlot="value", mapTitle="World Map for Hapiness in 2016",colourPalette="terrain")
```

The happiest countries are countries from Northern Europe, Australia, and Canada. Europe, America and Oceania are at a high level of happiness. Countries in Asia and Africa own a lower level of happiness, especially some countries at Africa.

##Cluster Analysis
```{r}
df_cluster = df%>%
  filter(year == 2016)%>%
  select(-year,-country,-life_ladder) 
df_cluster = scale(df_cluster) 
d_cluster = data.frame(
  country = df_map$country,
  data = df_cluster
) 

data.dist=dist(d_cluster)
plot(hclust(data.dist), labels=d_cluster$country, 
     main="Complete Linkage")
df_rank =
df_map%>%
  arrange(desc(value))
```
 
Cluster analysis is conducted using all variables expect life ladder. There are two main clusters and most countries in the left cluster has a higher GDP than the right one.

#regression tree
```{r}
df<-df[,-1:-2]
set.seed(1)
index <- createDataPartition(df$life_ladder, p=0.75, list=FALSE)
train_data <- df[index,]
test_data <- df[-index,]
```
Separate data set into train set and validation set in 3:1.  

```{r}
rpart.df <- rpart(life_ladder~log_gdp_per_capita+social_support+healthy_life_expectancy_at_birth+freedom_to_make_life_choices+generosity+perceptions_of_corruption+confidence_in_national_government+democratic_quality+delivery_quality, method="anova",data=train_data)
rpart.plot(rpart.df,type=3)
plotcp(rpart.df)#choose cp=0.014

#prune
pfit<- prune(rpart.df, cp=0.014)
rpart.plot(pfit,type=3,main="Pruned Regression tree for happiness score")
pred <- predict(pfit,test_data)
mean((pred - test_data$life_ladder)^2)  #0.315

```
Choose size=7 and cp=0.014,we get a prune tree with 7 terminal nodes and their means.  
The test error is 0.315.  

#bagging 
```{r}
set.seed(2)
bag_df <- randomForest(life_ladder~log_gdp_per_capita+social_support+healthy_life_expectancy_at_birth+freedom_to_make_life_choices+generosity+perceptions_of_corruption+confidence_in_national_government+democratic_quality+delivery_quality, data = train_data,mtry = 9, importance =TRUE)
importance(bag_df) #Health and social support and GPA are most important
pred_df <- predict(bag_df,test_data)
mean((pred_df - test_data$life_ladder)^2) #test error=0.156
```
Using bagging and we found that the three most important variables are healthy life expectancy at birth, GDP and social support. These three factors all have positive association with happiness scores.  
The test error is 0.156.  

#boosting
```{r}
train_control <- trainControl(method="cv", number=10)
# fix the parameters of the algorithm
grid <- expand.grid(n.trees=c(50,100,500,1000), #tuning parameter
                    shrinkage=c(0.01,0.05,0.1,0.5),
                    interaction.depth=c(2,4),
                    n.minobsinnode = c(10)) 
# train the model
set.seed(2)
model <- train(life_ladder~., 
               train_data, 
               trControl=train_control, 
               method="gbm", 
               tuneGrid=grid,
               preProcess = c("center","scale"),
               verbose = FALSE)
# summarize results
print(model)
summary(model) #healthy, gdp,social
pred_1 <- predict(model,test_data)
mean((pred_1 - test_data$life_ladder)^2) #0.20
```
Using boosting for scaled and center data, we found that the three most important variables are healthy life expectancy at birth,GDP and social support. These three factors all have positive association with happiness scores.   
The test error is 0.20.  

#rf
```{r}
set.seed(2)
model_rf<-train(life_ladder~.,
                train_data,
                importance=TRUE,
                method='rf', 
                trControl=train_control
                )
print(model_rf)
varImp(model_rf)
plot(varImp(object=model_rf),
     main="RF - Variable Importance") #healthy,social,democratic
pred_2 <- predict(model_rf,test_data)
mean((pred_2 - test_data$life_ladder)^2) #0.151
```
Using random forest and we found that the three most important variables are healthy life expectancy at birth,social support and democratic quality. These three factors all have positive association with happiness scores.   
The test error is 0.151.  

During these ensembel methods for regression tree, random forest method has smallest test error so that it is the best method. The three most important variables for happiness scores are similar. Healthy life expectancy at birth is the most important variable and the larger average equivalent number of years of full health that a newborn could expect to live,the higher happiness score will the people have. Higher GDP, complete social support and high democratic quality will bring people happiness.  
We can see that money of the country is not the most important factor of happiness but it still is a key point.Health and social support play a important part in people's happiness life. 